name: Create Tag on Keyword with Tag Name in Commit Message
# Keywords look like: "Release v0.0.0" or "Release v1.10.100"

on:
  push:
    branches:
      - main  # Adjust this to specify the branch(es) to monitor

jobs:
  tag_on_keyword:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Extract tag name from commit message
      id: extract_tag
      # Look for a "Release" keyword followed by the tag name (e.g.,
      # "Release v1.0.0")
      # "|| true" is necessary because grep exits 1 when no line is matched!
      run: |
        tag_name=$(git log -1 --pretty=%B | grep -oP "Release \Kv[0-9]+\.[0-9]+\.[0-9]+" || true)
        if [ -n "$tag_name" ]; then
          echo "tag_name=$tag_name" >> $GITHUB_ENV
          echo "found=true" >> $GITHUB_ENV
        else
          echo "found=false" >> $GITHUB_ENV
        fi
      continue-on-error: false  # Ensure no error is thrown even if the keyword is not found
      # above line "continue-on-error" should be redundant right now
    - name: Log that no action is required when keyword is not found
      if: env.found == 'false'
      run: echo "No matching keyword found in the commit message. No tag creation is required."

    - name: Create and push the tag if keyword is found
      if: env.found == 'true'
      run: |
        echo "Tag name extracted: ${{ env.tag_name }}"
        git tag -a ${{ env.tag_name }} -m "Automatically created tag ${{ env.tag_name }}"
        git push origin ${{ env.tag_name }}
